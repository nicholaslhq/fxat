<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXAT | FX-Adjusted Ticker</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #ffffff;
            --fg: #0f172a;
            --fg-muted: #64748b;
            --border: #e2e8f0;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 6px;
            --font-main: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg);
            color: var(--fg);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .layout {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Utility */
        .flex {
            display: flex;
            align-items: center;
        }

        .flex-col {
            display: flex;
            flex-direction: column;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .w-full {
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }

        .tracking-wide {
            letter-spacing: 0.05em;
        }

        .uppercase {
            text-transform: uppercase;
        }

        .text-muted {
            color: var(--fg-muted);
        }

        .font-semibold {
            font-weight: 600;
        }

        .font-bold {
            font-weight: 700;
        }

        /* Header */
        header {
            margin-bottom: 40px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 24px;
        }

        .brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .brand span {
            color: var(--fg-muted);
            font-weight: 400;
        }

        /* Controls */
        .controls-bar {
            margin-top: 24px;
            display: flex;
            gap: 24px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--fg-muted);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        input[type="text"] {
            font-family: var(--font-main);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--fg);
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--border);
            padding: 4px 0;
            width: 300px;
            border-radius: 0;
            transition: border-color 0.2s;
            text-transform: uppercase;
        }

        input[type="text"]::placeholder {
            color: var(--border);
            opacity: 0.5;
        }

        input[type="text"]:focus {
            border-color: var(--accent);
        }

        button {
            cursor: pointer;
            font-family: var(--font-main);
            border: none;
            background: transparent;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--fg);
            color: #fff;
            padding: 10px 24px;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: var(--radius);
            height: 42px;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Status & Meta */
        #status-area {
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .status-error {
            color: var(--danger);
        }

        .status-loading {
            color: var(--accent);
        }

        .meta-section {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        #meta-name {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .meta-detail {
            font-size: 0.9rem;
            color: var(--fg-muted);
            font-family: var(--font-mono);
        }

        /* Stats Grid */
        #stats-area {
            margin-bottom: 48px;
            border-top: 1px solid var(--border);
            padding-top: 24px;
        }

        #stats-period {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--fg-muted);
            margin-bottom: 16px;
            text-align: left;
        }

        #stats-rows {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 24px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-val-l {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--fg);
            letter-spacing: -0.02em;
        }

        .stat-sub {
            font-size: 0.8rem;
            color: var(--fg-muted);
            margin-top: 2px;
        }

        .val-pos {
            color: var(--success);
        }

        .val-neg {
            color: var(--danger);
        }

        /* Chart Section */
        .chart-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .btn-group {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 2px;
            border-radius: 6px;
            justify-content: space-between;
        }

        .btn-toggle {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--fg-muted);
            padding: 4px 12px;
            border-radius: 4px;
        }

        .btn-toggle:hover {
            color: var(--fg);
        }

        .btn-toggle.active {
            background: #fff;
            color: var(--fg);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        #chart {
            width: 100%;
            min-height: 500px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        /* Table */
        .table-section {
            margin-top: 40px;
        }

        .btn-text {
            color: var(--fg-muted);
            font-size: 0.85rem;
            font-weight: 500;
            border-bottom: 1px solid transparent;
        }

        .btn-text:hover {
            color: var(--fg);
            border-color: var(--fg);
        }

        .table-responsive {
            margin-top: 16px;
            overflow-x: auto;
            border-top: 2px solid var(--fg);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: right;
            white-space: nowrap;
        }

        th {
            text-align: right;
            font-weight: 600;
            color: var(--fg-muted);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--fg);
            font-feature-settings: "tnum";
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Interpretation */
        .hint-box {
            margin-top: 16px;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.85rem;
            color: var(--fg-muted);
            line-height: 1.6;
        }

        .hint-box strong {
            color: var(--fg);
            font-weight: 600;
        }

        @media (max-width: 768px) {

            .controls-bar,
            .meta-section,
            .chart-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="text"] {
                width: 100%;
            }

            .btn-group {
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <header class="flex-col">
            <div class="brand flex items-center justify-between">
                <h1>FXAT <span>/ FX-Adjusted Ticker</span></h1>
            </div>
            <div class="controls-bar">
                <div class="input-block">
                    <label class="input-label" for="ticker">Asset Ticker</label>
                    <input id="ticker" type="text" placeholder="AAPL" spellcheck="false">
                </div>
                <div class="input-block">
                    <label class="input-label" for="targetCurrency">Currency</label>
                    <input id="targetCurrency" type="text" placeholder="EUR, GBP" spellcheck="false">
                </div>
                <button id="btn-run" class="btn-primary" onclick="runApp()">Analyze</button>
            </div>
        </header>

        <div id="status-area" class="hidden"></div>

        <div id="results-area" class="hidden">
            <div class="meta-section">
                <div>
                    <h2 id="meta-name">-</h2>
                    <div class="meta-detail"><span id="meta-symbol">-</span> / <span id="meta-base">-</span></div>
                </div>
            </div>

            <div id="stats-area">
                <div id="stats-period"></div>
                <div id="stats-rows"></div>
            </div>

            <div class="chart-section">
                <div class="chart-toolbar">
                    <div class="flex gap-4">
                        <div id="dual-axis-toggle" class="btn-group hidden">
                            <button class="btn-toggle active" onclick="setDualAxis(false)"
                                data-axis="off">Simple</button>
                            <button class="btn-toggle" onclick="setDualAxis(true)" data-axis="on">Dual Axis</button>
                        </div>
                        <div id="view-toggle" class="btn-group hidden">
                            <button class="btn-toggle active" onclick="setViewMode('overlay')"
                                data-view="overlay">Overlay</button>
                            <button class="btn-toggle" onclick="setViewMode('stacked')"
                                data-view="stacked">Stacked</button>
                        </div>
                    </div>
                    <div class="btn-group time-ranges">
                        <button class="btn-toggle" onclick="setRange('1M')" data-range="1M">1M</button>
                        <button class="btn-toggle" onclick="setRange('6M')" data-range="6M">6M</button>
                        <button class="btn-toggle" onclick="setRange('YTD')" data-range="YTD">YTD</button>
                        <button class="btn-toggle" onclick="setRange('1Y')" data-range="1Y">1Y</button>
                        <button class="btn-toggle" onclick="setRange('3Y')" data-range="3Y">3Y</button>
                        <button class="btn-toggle" onclick="setRange('5Y')" data-range="5Y">5Y</button>
                        <button class="btn-toggle active" onclick="setRange('MAX')" data-range="MAX">MAX</button>
                    </div>
                </div>

                <div id="chart"></div>

                <div class="hint-box">
                    <div class="flex items-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span><strong>Tip:</strong> Click and drag on the chart to zoom and view returns for a specific
                            period. Double-click to reset.</span>
                    </div>
                </div>

                <div id="interpretation-section" class="hint-box hidden">
                    <div class="flex items-center gap-2" style="margin-bottom:8px;color:var(--fg)"><svg width="16"
                            height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg> <strong>Interpreting Dual-Axis</strong></div>
                    <ul style="margin:0;padding-left:20px;list-style-type:disc">
                        <li><strong>Solid Line:</strong> Adjusted Value. If higher than dotted, currency exchange is
                            favorable.</li>
                        <li><strong>Dotted Line:</strong> Original Price (Base Currency).</li>
                    </ul>
                </div>
            </div>

            <div class="table-section">
                <button class="btn-text" onclick="toggleTable()"><span id="table-toggle-text">Show Data
                        Table</span></button>
                <div id="table-container" class="table-responsive hidden">
                    <table id="dataTable">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id),
            YAHOO_BASE = 'https://query1.finance.yahoo.com/v8/finance/chart/',
            PROXY_URL = 'https://corsproxy.io/?',
            CHART_COLORS = ['#2563eb', '#0891b2', '#7c3aed', '#db2777', '#ea580c'],
            UI = {
                ticker: $('ticker'),
                currency: $('targetCurrency'),
                run: $('btn-run'),
                status: $('status-area'),
                results: $('results-area'),
                name: $('meta-name'),
                symbol: $('meta-symbol'),
                base: $('meta-base'),
                viewT: $('view-toggle'),
                dualT: $('dual-axis-toggle'),
                inter: $('interpretation-section'),
                stats: $('stats-rows'),
                period: $('stats-period'),
                chart: $('chart'),
                table: $('dataTable'),
                tableC: $('table-container'),
                tableT: $('table-toggle-text')
            };

        let G = { baseMeta: {}, series: [], mode: 'overlay', dual: false };

        const fmt = (v, c) => new Intl.NumberFormat('en-US', { style: 'currency', currency: c }).format(v);

        const showS = (m, t = 'normal') => {
            UI.status.className = t === 'error' ? 'status-error' : (t === 'loading' ? 'status-loading' : '');
            UI.status.classList.remove('hidden');
            UI.status.innerHTML = t === 'loading' ? `<div class="flex gap-2"><span>●</span> ${m}</div>` : (t === 'error' ? `<strong>Error:</strong> ${m}` : m);
        };

        async function fetchY(s) {
            const r = await fetch(PROXY_URL + encodeURIComponent(`${YAHOO_BASE}${s}?range=10y&interval=1d`));
            if (!r.ok) throw Error(`HTTP ${r.status}`);
            const j = await r.json(), res = j.chart?.result?.[0];
            if (!res) throw Error(`No data for ${s}`);
            const ts = res.timestamp || [],
                q = res.indicators.quote[0],
                p = res.indicators.adjclose?.[0]?.adjclose || q.close || [],
                m = res.meta;
            const data = {}, dates = [];
            ts.forEach((t, i) => {
                if (p[i] != null) {
                    const d = new Date(t * 1000).toISOString().split('T')[0];
                    data[d] = p[i];
                    dates.push(d);
                }
            });
            return { symbol: m.symbol, currency: m.currency, longName: m.longName || m.shortName || m.symbol, data, dates };
        }

        async function runApp() {
            const tic = UI.ticker.value.trim().toUpperCase(),
                raw = UI.currency.value.trim().toUpperCase();
            let curs = raw.split(',').map(c => c.trim()).filter(c => c);
            const lim = curs.length > 5;
            if (lim) curs = curs.slice(0, 5);

            if (!tic || !curs.length) return showS("Please enter a ticker and at least one currency.", "error");

            UI.results.classList.add('hidden');
            UI.run.disabled = true;
            showS(`Fetching data for <b>${tic}</b>...`, "loading");

            try {
                const s = await fetchY(tic);
                G.baseMeta = { symbol: s.symbol, currency: s.currency, name: s.longName };
                G.series = [];

                showS(`Processing exchange rates...`, "loading");

                for (let i = 0; i < curs.length; i++) {
                    const t = curs[i];
                    let fx = null, inv = false;
                    if (t !== s.currency) {
                        try { fx = (await fetchY(`${s.currency}${t}=X`)).data; }
                        catch {
                            try { fx = (await fetchY(`${t}${s.currency}=X`)).data; inv = true; }
                            catch { throw Error(`Invalid currency: ${t}`); }
                        }
                    }

                    let last = null;
                    const mapped = s.dates.map(d => {
                        let r = fx ? (fx[d] ?? last) : 1;
                        if (fx && fx[d] != null) last = fx[d];
                        return r != null ? { d, o: s.data[d], c: s.data[d] * (inv ? 1 / r : r) } : null;
                    }).filter(x => x);

                    G.series.push({ cur: t, data: mapped, col: CHART_COLORS[i % 5] });
                }

                UI.results.classList.remove('hidden');
                UI.status.classList.add('hidden');
                UI.name.textContent = G.baseMeta.name;
                UI.symbol.textContent = G.baseMeta.symbol;
                UI.base.textContent = G.baseMeta.currency;

                // Logic for view toggles
                UI.viewT.classList.toggle('hidden', G.series.length < 2);

                const hasDiff = G.series.some(s => s.cur !== G.baseMeta.currency);
                UI.dualT.classList.toggle('hidden', !hasDiff);
                if (!hasDiff) G.dual = false;

                syncDualUI();
                setRange('MAX');

                if (lim) showS("Note: Comparison limited to top 5 currencies.", "normal");

            } catch (e) { showS(e.message, "error"); }
            finally { UI.run.disabled = false; }
        }

        const syncDualUI = () => {
            document.querySelectorAll('#dual-axis-toggle .btn-toggle').forEach(b => b.classList.toggle('active', b.dataset.axis === (G.dual ? 'on' : 'off')));
            UI.inter.classList.toggle('hidden', !G.dual);
        };

        function setViewMode(m) {
            G.mode = m;
            document.querySelectorAll('#view-toggle .btn-toggle').forEach(b => b.classList.toggle('active', b.dataset.view === m));
            setRange(document.querySelector('.time-ranges .active')?.dataset.range || 'MAX');
        }

        function setDualAxis(e) {
            G.dual = e;
            syncDualUI();
            setRange(document.querySelector('.time-ranges .active')?.dataset.range || 'MAX');
        }

        function setRange(r) {
            document.querySelectorAll('.time-ranges .btn-toggle').forEach(b => b.classList.toggle('active', b.dataset.range === r));
            if (!G.series.length) return;

            const now = new Date();
            let cut = new Date('1900-01-01');

            if (r === 'YTD') cut = new Date(now.getFullYear(), 0, 1);
            else if (r !== 'MAX') {
                cut = new Date(now);
                const n = parseInt(r);
                if (r.includes('Y')) cut.setFullYear(now.getFullYear() - n);
                else cut.setMonth(now.getMonth() - n);
            }

            const filtered = G.series.map(s => ({ ...s, data: s.data.filter(d => new Date(d.d) >= cut) })).filter(s => s.data.length > 1);

            draw(filtered);
            upStats(filtered);
            upTab(filtered);
        }

        function upStats(list) {
            if (!list.length) return;

            const sD = new Date(list[0].data[0].d), eD = new Date(list[0].data[list[0].data.length - 1].d);
            const opts = { year: 'numeric', month: 'short', day: 'numeric' };
            UI.period.textContent = `${sD.toLocaleDateString('en-US', opts)} – ${eD.toLocaleDateString('en-US', opts)}`;

            UI.stats.innerHTML = list.map(s => {
                const b = s.data[0], e = s.data[s.data.length - 1], ch = e.c - b.c, p = (ch / b.c) * 100;
                const cls = ch >= 0 ? 'val-pos' : 'val-neg', sgn = ch >= 0 ? '+' : '';
                return `<div class="stat-item">
                    <div class="stat-label"><div class="stat-dot" style="background:${s.col}"></div> ${s.cur} RETURN</div>
                    <div class="stat-val-l ${cls}">${sgn}${p.toFixed(2)}%</div>
                    <div class="stat-sub">${sgn}${fmt(ch, s.cur)}</div>
                    <div class="stat-sub" style="margin-top:8px">Start: ${fmt(b.c, s.cur)}</div>
                    <div class="stat-sub">End: ${fmt(e.c, s.cur)}</div>
                </div>`;
            }).join('');
        }

        function draw(list) {
            const cnt = list.length;
            if (!cnt) return;
            const stack = G.mode === 'stacked' && cnt > 1;

            const layout = {
                height: stack ? 400 + (cnt - 1) * 250 : 600,
                margin: { l: 40, r: 40, t: 20, b: 40 },
                font: { family: 'Inter, sans-serif', color: '#64748b' },
                showlegend: !stack,
                legend: { orientation: 'h', y: 1.05, x: 0 },
                hovermode: 'x unified',
                dragmode: 'select',
                selectdirection: 'h',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                xaxis: {
                    showgrid: false,
                    linecolor: '#e2e8f0'
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: '#f1f5f9',
                    zerolinecolor: '#e2e8f0'
                }
            };

            const traces = [];

            if (stack) {
                layout.grid = { rows: cnt, columns: 1, pattern: 'independent' };
                list.forEach((s, i) => {
                    const ax = i === 0 ? '' : i + 1;
                    traces.push({
                        x: s.data.map(d => d.d), y: s.data.map(d => d.c),
                        xaxis: `x${ax}`, yaxis: `y${ax}`, type: 'scatter', mode: 'lines',
                        line: { color: s.col, width: 2 }, name: s.cur,
                        fill: 'tozeroy', fillcolor: s.col + '10',
                        hovertemplate: `%{y:.2f}<extra></extra>`
                    });

                    if (G.dual && s.cur !== G.baseMeta.currency) {
                        const sAx = cnt + 1 + i, yId = `y${sAx}`;
                        traces.push({
                            x: s.data.map(d => d.d), y: s.data.map(d => d.o),
                            xaxis: `x${ax}`, yaxis: yId, type: 'scatter', mode: 'lines',
                            line: { color: '#94a3b8', width: 2, dash: 'dot' },
                            name: `${G.baseMeta.currency} (Base)`, showlegend: i === 0,
                            hovertemplate: `%{y:.2f}<extra></extra>`
                        });
                        layout[`yaxis${sAx}`] = { overlaying: `y${ax}`, side: 'right', showgrid: false, fixedrange: true };
                    }

                    layout[`yaxis${ax}`] = { title: { text: s.cur, font: { color: s.col, size: 10 } }, showgrid: true, gridcolor: '#f1f5f9', fixedrange: true };
                    layout[`xaxis${ax}`] = { showgrid: false, matches: 'x', showticklabels: i === cnt - 1, linecolor: '#e2e8f0' };
                });
            } else {
                list.forEach(s => traces.push({
                    x: s.data.map(d => d.d), y: s.data.map(d => d.c),
                    type: 'scatter', mode: 'lines', line: { color: s.col, width: 2 },
                    name: s.cur, fill: 'tozeroy', fillcolor: s.col + '0A',
                    hovertemplate: `%{y:.2f}<extra></extra>`
                }));

                if (G.dual && cnt) {
                    traces.push({
                        x: list[0].data.map(d => d.d), y: list[0].data.map(d => d.o),
                        yaxis: 'y2', type: 'scatter', mode: 'lines',
                        line: { color: '#94a3b8', width: 2, dash: 'dot' },
                        name: `${G.baseMeta.currency} (Base)`,
                        hovertemplate: `%{y:.2f}<extra></extra>`
                    });
                    layout.yaxis2 = { title: G.baseMeta.currency, overlaying: 'y', side: 'right', showgrid: false };
                }
            }

            const chartEl = document.getElementById('chart');
            Plotly.react(chartEl, traces, layout, { responsive: true, displayModeBar: false }).then(() => {
                chartEl.removeListener?.('plotly_selected', () => { });
                chartEl.removeAllListeners?.('plotly_selected');

                chartEl.on('plotly_selected', e => {
                    const xr = e?.range?.x || e?.range?.x2;
                    if (!xr || xr.length !== 2) return;

                    // Convert selection bounds to timestamps
                    const tStart = new Date(xr[0]).getTime();
                    const tEnd = new Date(xr[1]).getTime();

                    // Snap Function: Finds the nearest date in the dataset
                    const snap = (t) => {
                        let best = null, minDiff = Infinity;
                        if (!list[0]?.data) return null;
                        for (const pt of list[0].data) {
                            // Ensure data dates are treated as timestamps too
                            const dTs = new Date(pt.d).getTime();
                            const diff = Math.abs(dTs - t);
                            if (diff < minDiff) { minDiff = diff; best = pt.d; }
                        }
                        return best;
                    };

                    const realStart = snap(tStart);
                    const realEnd = snap(tEnd);

                    if (!realStart || !realEnd) return;

                    // Filter Logic: Compare lexical strings (ISO dates YYYY-MM-DD are lexicographically sorted)
                    const subList = list.map(s => ({
                        ...s,
                        data: s.data.filter(d => d.d >= realStart && d.d <= realEnd)
                    })).filter(s => s.data.length > 1);

                    if (subList.length) {
                        upStats(subList);

                        // Visual Feedback: Vertical dashed lines + faint rectangle
                        const shapes = [
                            { type: 'line', x0: realStart, x1: realStart, y0: 0, y1: 1, yref: 'paper', line: { color: '#aaa', width: 1, dash: 'dash' } },
                            { type: 'line', x0: realEnd, x1: realEnd, y0: 0, y1: 1, yref: 'paper', line: { color: '#aaa', width: 1, dash: 'dash' } },
                            { type: 'rect', x0: realStart, x1: realEnd, y0: 0, y1: 1, yref: 'paper', fillcolor: '#aaa', opacity: 0.1, line: { width: 0 } }
                        ];
                        Plotly.relayout(chartEl, { shapes: shapes });
                    }
                });

                const reset = () => {
                    setRange(document.querySelector('.time-ranges .active')?.dataset.range || 'MAX');
                    Plotly.relayout(chartEl, { shapes: [] });
                };

                chartEl.removeListener?.('plotly_doubleclick', reset);
                chartEl.removeListener?.('plotly_deselect', reset);

                chartEl.on('plotly_doubleclick', reset);
                chartEl.on('plotly_deselect', reset);
            });
        }

        function upTab(list) {
            if (!list.length) return;
            const head = UI.table.querySelector('thead'), body = UI.table.querySelector('tbody');
            head.innerHTML = `<tr><th>Date</th><th>Base (${G.baseMeta.currency})</th>${list.map(s => `<th style="color:${s.col}">${s.cur}</th>`).join('')}</tr>`;

            const m = list[0].data, start = Math.max(0, m.length - 30);
            let h = '';
            for (let i = m.length - 1; i >= start; i--) {
                const pt = m[i];
                h += `<tr><td>${pt.d}</td><td>${pt.o.toFixed(2)}</td>${list.map(s => `<td>${s.data[i] ? s.data[i].c.toFixed(2) : '-'}</td>`).join('')}</tr>`;
            }
            body.innerHTML = h;
        }

        function toggleTable() {
            const h = UI.tableC.classList.toggle('hidden');
            UI.tableT.textContent = (h ? "Show" : "Hide") + " Data Table";
        }

        UI.ticker.onkeyup = UI.currency.onkeyup = e => e.key === 'Enter' && runApp();

    </script>
</body>

</html>